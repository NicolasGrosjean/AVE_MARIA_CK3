# On actions for war events, triggered automatically by the game

# called for wars after being transferred to a new defender
# root is the primary attacker
# scope:war is the war
# scope:defender is the new defender

on_war_transferred = {
	events = {
		war_event.2001 # allows attacker to back out of the war
	}
}

# called for people joining as a secondary attacker or defender
# root is the joiner
# scope:war is the war

on_join_war_as_secondary = {
	events = {
		war_event.3000 # Ally gets mad if you do not participate in their wars.
	}
}

# called when a war is started.
# same scopes are available in these events as in the CBs' on_declaration, this just fires for all CBs instead of a specific CB.

on_war_started = {
	effect = {
		scope:attacker = {
			if = {
				limit = {
					any_vassal_or_below = { is_ai = no }
				}
				every_vassal_or_below = {
					limit = { is_ai = no }
					send_interface_toast = {
						type = msg_war_declared_by_liege
						title = msg_war_declared_by_liege
						desc = msg_war_declared_by_liege_desc
						left_icon = scope:attacker
						right_icon = scope:defender
					}
				}
			}
		}
		scope:defender = {
			if = {
				limit = {
					any_vassal_or_below = { is_ai = no }
				}
				every_vassal_or_below = {
					limit = { is_ai = no }
					send_interface_toast = {
						type = msg_war_declared_on_liege
						title = msg_war_declared_on_liege
						desc = msg_war_declared_on_liege_desc
						left_icon = scope:defender
						right_icon = scope:attacker
					}
				}
			}
		}


		### AVE MARIA ROMAN ADMINISTRATION
		## Local Military Commanders and Central Tagma automatically join defensive the war of the emperor
		if = {
			limit = {
				scope:attacker = {
					roman_administration_character_is_in_the_empire = no
					any_character_war = {
						NOR = {
							using_cb = claimant_faction_war
							using_cb = depose_war
							using_cb = refused_liege_demand_war
							using_cb = independence_war
						}
					}					
				}
			}
			scope:defender = {
				if = {
					limit = {
						any_held_title = {
							this = title:e_byzantium
						}				
						scope:war = {
							NOR = {
								using_cb = claimant_faction_war
								using_cb = depose_war
								using_cb = refused_liege_demand_war
								using_cb = independence_war
							}
						}
					}
					save_scope_as = basileus
	
					# scope:war = {
					# 	save_scope_as = war_to_join
					# 	casus_belli = {
					# 		random_target_title = {
					# 			save_scope_as = war_title
					# 		}								
					# 	}
					# }
					scope:defender = {
						every_vassal = {
							if = {
								limit = {
									highest_held_title_tier = tier_duchy
									OR = {
										has_government = roman_administration_doukaton_government
										AND = {
											has_government = roman_administration_theme_government
											OR = {
												vassal_contract_has_flag = full_service_theme_flag
												vassal_contract_has_flag = protimesis_theme_flag
												vassal_contract_has_flag = tax_exemptions_theme_flag
												vassal_contract_has_flag = voluntary_theme_flag
												vassal_contract_has_flag = peacetime_theme_flag
											}
											
										}									
										has_government = roman_administration_military_government
									}
									is_a_faction_member = no
									# NOT = {
									# 	joined_faction = {
									# 		NOR = {
									# 			faction_is_type = liberty_faction
									# 			faction_is_type = claimant_faction	
									# 		}
									# 	}
									# }
									# trigger_if = {
									# 	limit = { is_a_faction_member = yes }
									# 	joined_faction = {
									# 		NOR = {
									# 			faction_is_type = liberty_faction
									# 			faction_is_type = claimant_faction	
									# 		}
									# 	}
									# }								
								}
								save_scope_as = tagma_commander
							}
						}
						## Provincial Commanders
						every_vassal = {
							if = {
								limit = {
									highest_held_title_tier = tier_duchy
									OR = {
										has_government = roman_administration_doukaton_government
										AND = {
											has_government = roman_administration_theme_government
											OR = {
												vassal_contract_has_flag = full_service_theme_flag
												vassal_contract_has_flag = protimesis_theme_flag
												vassal_contract_has_flag = tax_exemptions_theme_flag
												vassal_contract_has_flag = voluntary_theme_flag
												vassal_contract_has_flag = peacetime_theme_flag
											}										
										}	
									}
									is_a_faction_member = no
									# trigger_if = {
									# 	limit = { is_a_faction_member = yes }
									# 	joined_faction = {
									# 		NOR = {
									# 			faction_is_type = liberty_faction
									# 			faction_is_type = claimant_faction	
									# 		}
									# 	}
									# }
									primary_title = {
										scope:attacker = {
											realm_to_title_distance_squared = {
												title = prev
												value <= squared_distance_medium #250 map-pixels. Roughly one Ireland away (top to bottom).
											}
										}
									}
								}										
								scope:war = {
									add_defender = prev
								}							
							}
						}
						## Central Tagma
						every_vassal = {
							if = {
								limit = {
									has_government = roman_administration_military_government
									NOR = {
										has_title = title:d_optimatoi
										has_title = title:d_noumeroi
										has_title = title:d_megas_droungarios
										has_title = title:d_varangian_guard
									}
									NOT = { has_character_flag = mustered }
									is_a_faction_member = no
									# trigger_if = {
									# 	limit = { is_a_faction_member = yes }
									# 	joined_faction = {
									# 		NOR = {
									# 			faction_is_type = liberty_faction
									# 			faction_is_type = claimant_faction	
									# 		}
									# 	}
									# }
								}
								scope:war = {
									add_defender = prev
								}
								add_character_flag = mustered
								spawn_army = {
									name = "tagma_army_name"
									# levies = 0
									men_at_arms = {
										type = cataphract
										stacks = 5
									}
									# men_at_arms = {
									# 	type = house_guard
									# 	stacks = 25
									# }
									# men_at_arms = {
									# 	type = bowmen
									# 	stacks = 10
									# }
									location = 496
									origin = 496
									save_scope_as = tagma_army
									inheritable = no
									war = scope:war
								}
							}
						}
					}
				}
			}
		}		

		## Local Military Commanders and Central Tagma automatically join Offensive the war of the emperor
		scope:attacker = {
			if = {
				limit = {
					any_held_title = {
						this = title:e_byzantium
					}					
				}
				save_scope_as = basileus

				# scope:war = {
				# 	save_scope_as = war_to_join
				# 	casus_belli = {
				# 		random_target_title = {
				# 			save_scope_as = war_title
				# 		}								
				# 	}
				# }
				scope:attacker = {
					every_vassal = {
						if = {
							limit = {
								OR = {
									has_government = roman_administration_doukaton_government
									AND = {
										has_government = roman_administration_theme_government
										OR = {
											vassal_contract_has_flag = full_service_theme_flag
											vassal_contract_has_flag = protimesis_theme_flag
											vassal_contract_has_flag = tax_exemptions_theme_flag
											vassal_contract_has_flag = voluntary_theme_flag
											vassal_contract_has_flag = peacetime_theme_flag
										}										
									}
									has_government = roman_administration_military_government
								}
								
							}
							save_scope_as = tagma_commander
						}
					}
					## Provincial Commanders
					every_vassal = {
						if = {
							limit = {
								OR = {
									has_government = roman_administration_doukaton_government
									AND = {
										has_government = roman_administration_theme_government
										OR = {
											vassal_contract_has_flag = full_service_theme_flag
											vassal_contract_has_flag = protimesis_theme_flag
											vassal_contract_has_flag = tax_exemptions_theme_flag
											vassal_contract_has_flag = voluntary_theme_flag
											vassal_contract_has_flag = peacetime_theme_flag
										}										
									}
								}
								
								primary_title = {
									scope:defender = {
										realm_to_title_distance_squared = {
											title = prev
											value <= squared_distance_medium #250 map-pixels. Roughly one Ireland away (top to bottom).
										}
									}
								}
							}										
							scope:war = {
								add_attacker = prev
							}							
						}
					}
					## Central Tagma
					every_vassal = {
						if = {
							limit = {
								has_government = roman_administration_military_government
								NOR = {
									has_title = title:d_optimatoi
									has_title = title:d_noumeroi
									has_title = title:d_megas_droungarios
									has_title = title:d_varangian_guard
								}
								NOT = { has_character_flag = mustered }
							}
							scope:war = {
								add_attacker = prev
							}
							add_character_flag = mustered
							spawn_army = {
								name = "Tagma"
								# levies = 0
								men_at_arms = {
									type = cataphract
									stacks = 5
								}
								# men_at_arms = {
								# 	type = house_guard
								# 	stacks = 25
								# }
								# men_at_arms = {
								# 	type = bowmen
								# 	stacks = 10
								# }
								location = 496
								origin = 496
								save_scope_as = tagma_army
								inheritable = no
								war = scope:war
							}
						}
					}
				}
			}
		}

		### AVE MARIA ISLAM
		## Regiments automatically join a defensive war
		scope:defender = {
			if = {
				limit = {
					uses_islamic_empire_govt = yes
					highest_held_title_tier = tier_empire
				}
				## Abid
				every_vassal = {				
					limit = {
						any_held_title = {
							has_variable = islamic_empire_regiment_size
							has_variable = abid_regiment
						}
						has_government = islamic_empire_regiment_government
						NOT = { has_character_flag = mustered }
					}
					primary_title = {
						save_scope_as = primary_regiment_title
					}
					scope:war = {
						add_defender = prev
					}
					add_character_flag = mustered
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_infantry > 0
							}
						}
						spawn_army = {
							name = "nubian_ghilman"
							men_at_arms = {
								type = ghilman_nubians
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_infantry
							}
							location = scope:defender.capital_province
							origin = scope:defender.capital_province
							save_scope_as = ghulam_army_abid
							inheritable = no
							war = scope:war
						}
					}					
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_light_cavalry > 0
							}
						}
						spawn_army = {
							name = "nubian_ghilman"
							men_at_arms = {
								type = sahel_horsemen
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_light_cavalry
							}
							location = scope:defender.capital_province
							origin = scope:defender.capital_province
							save_scope_as = ghulam_army_abid
							inheritable = no
							war = scope:war
						}
					}
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_heavy_cavalry > 0
							}
						}
						spawn_army = {
							name = "nubian_ghilman"
							men_at_arms = {
								type = mamluk_cavalry
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_heavy_cavalry
							}
							location = scope:defender.capital_province
							origin = scope:defender.capital_province
							save_scope_as = ghulam_army_abid
							inheritable = no
							war = scope:war
						}
					}					
					
					
				}
				## Ghulam Turks
				every_vassal = {				
					limit = {
						any_held_title = {
							has_variable = islamic_empire_regiment_size
							has_variable = turkish_ghulam_regiment
						}
						has_government = islamic_empire_regiment_government
						NOT = { has_character_flag = mustered }
					}
					primary_title = {
						save_scope_as = primary_regiment_title
					}
					scope:war = {
						add_defender = prev
					}
					add_character_flag = mustered

					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_infantry > 0
							}
						}
						spawn_army = {
							name = "mamluks"
							men_at_arms = {
								type = ghilman_nubians
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_infantry
							}
							location = scope:defender.capital_province
							origin = scope:defender.capital_province
							save_scope_as = ghulam_army
							inheritable = no
							war = scope:war
						}
					}
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_light_cavalry > 0
							}
						}
						spawn_army = {
							name = "mamluks"
							men_at_arms = {
								type = sahel_horsemen
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_light_cavalry
							}
							location = scope:defender.capital_province
							origin = scope:defender.capital_province
							save_scope_as = ghulam_army
							inheritable = no
							war = scope:war
						}
					}
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_heavy_cavalry > 0
							}
						}
						spawn_army = {
							name = "mamluks"
							men_at_arms = {
								type = mamluk_cavalry
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_heavy_cavalry
							}
							location = scope:defender.capital_province
							origin = scope:defender.capital_province
							save_scope_as = ghulam_army
							inheritable = no
							war = scope:war
						}
					}
					
				}
				## Local amirs
				every_vassal = {
					limit = {
						NOT = {
							has_government = islamic_empire_regiment_government
							has_character_flag = mustered
						}
						primary_title = {
							scope:attacker = {
								realm_to_title_distance_squared = {
									title = prev
									value <= squared_distance_medium #250 map-pixels. Roughly one Ireland away (top to bottom).
								}
							}
						}
					}
					scope:war = {
						add_defender = prev
					}
				}
			}
		}
		## Regiments automatically join an offensive war
		scope:attacker = {
			if = {
				limit = {
					uses_islamic_empire_govt = yes
					highest_held_title_tier = tier_empire
				}
				## Abid
				every_vassal = {				
					limit = {
						any_held_title = {
							#has_variable = islamic_empire_regiment_size
							has_variable = abid_regiment
						}
						has_government = islamic_empire_regiment_government
						NOT = { has_character_flag = mustered }
					}
					primary_title = {
						save_scope_as = primary_regiment_title
					}
					scope:war = {
						add_attacker = prev
					}
					add_character_flag = mustered

					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_infantry > 0
							}
						}
						spawn_army = {
							name = "nubian_ghilman"
							men_at_arms = {
								type = ghilman_nubians
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_infantry
							}
							location = scope:attacker.capital_province
							origin = scope:attacker.capital_province
							save_scope_as = ghulam_army_abid
							inheritable = no
							war = scope:war
						}
					}
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_light_cavalry > 0
							}
						}
						spawn_army = {
							name = "nubian_ghilman"
							men_at_arms = {
								type = sahel_horsemen
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_light_cavalry
							}
							location = scope:attacker.capital_province
							origin = scope:attacker.capital_province
							save_scope_as = ghulam_army_abid
							inheritable = no
							war = scope:war
						}
					}
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_heavy_cavalry > 0
							}
						}
						spawn_army = {
							name = "nubian_ghilman"
							men_at_arms = {
								type = mamluk_cavalry
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_heavy_cavalry
							}
							location = scope:attacker.capital_province
							origin = scope:attacker.capital_province
							save_scope_as = ghulam_army_abid
							inheritable = no
							war = scope:war
						}
					}
				}
				## Ghulam Turks
				every_vassal = {				
					limit = {
						any_held_title = {
							has_variable = turkish_ghulam_regiment
						}
						has_government = islamic_empire_regiment_government
						NOT = { has_character_flag = mustered }
					}
					primary_title = {
						save_scope_as = primary_regiment_title
					}
					scope:war = {
						add_attacker = prev
					}
					add_character_flag = mustered

					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_infantry > 0
							}
						}
						spawn_army = {
							name = "mamluks"
							men_at_arms = {
								type = house_guard
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_infantry
							}
							location = scope:attacker.capital_province
							origin = scope:attacker.capital_province
							save_scope_as = ghulam_army
							inheritable = no
							war = scope:war
						}
					}
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_light_cavalry > 0
							}
						}
						spawn_army = {
							name = "mamluks"
							men_at_arms = {
								type = sahel_horsemen
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_light_cavalry
							}
							location = scope:attacker.capital_province
							origin = scope:attacker.capital_province
							save_scope_as = ghulam_army
							inheritable = no
							war = scope:war
						}
					}
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_heavy_cavalry > 0
							}
						}
						spawn_army = {
							name = "mamluks"
							men_at_arms = {
								type = mamluk_cavalry
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_heavy_cavalry
							}
							location = scope:attacker.capital_province
							origin = scope:attacker.capital_province
							save_scope_as = ghulam_army
							inheritable = no
							war = scope:war
						}
					}
					
				}
				## Local amirs
				every_vassal = {
					limit = {
						NOT = {
							has_government = islamic_empire_regiment_government
							has_character_flag = mustered
						}
						primary_title = {
							scope:defender = {
								realm_to_title_distance_squared = {
									title = prev
									value <= squared_distance_medium #250 map-pixels. Roughly one Ireland away (top to bottom).
								}
							}
						}
					}
					scope:war = {
						add_attacker = prev
					}
				}
			}
		}

		## Regiment civil war - troop spawning
		scope:attacker = {
			if = {
				limit = {
					has_government = islamic_empire_regiment_government					
				}
				primary_title = {
					save_scope_as = primary_regiment_title
				}
				liege = {
					capital_province = {
						save_scope_as = liege_capital
					}
				}
				## Abid
				if = {
					limit = {
						any_held_title = {
							has_variable = islamic_empire_regiment_size
							has_variable = abid_regiment
						}
						has_government = islamic_empire_regiment_government
						NOT = { has_character_flag = mustered }
					}
					## Troop spawning
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_infantry > 0
							}
						}
						spawn_army = {
							name = "nubian_ghilman"
							men_at_arms = {
								type = ghilman_nubians
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_infantry
							}
							location = scope:liege_capital
							origin = scope:liege_capital
							save_scope_as = ghulam_army_abid
							inheritable = no
							war = scope:war
						}
					}					
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_light_cavalry > 0
							}
						}
						spawn_army = {
							name = "nubian_ghilman"
							men_at_arms = {
								type = sahel_horsemen
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_light_cavalry
							}
							location = scope:liege_capital
							origin = scope:liege_capital
							save_scope_as = ghulam_army_abid
							inheritable = no
							war = scope:war
						}
					}
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_heavy_cavalry > 0
							}
						}
						spawn_army = {
							name = "nubian_ghilman"
							men_at_arms = {
								type = mamluk_cavalry
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_heavy_cavalry
							}
							location = scope:liege_capital
							origin = scope:liege_capital
							save_scope_as = ghulam_army_abid
							inheritable = no
							war = scope:war
						}
					}	
				}
				## turks
				if = {
					limit = {
						any_held_title = {
							has_variable = islamic_empire_regiment_size
							has_variable = turkish_ghulam_regiment
						}
						has_government = islamic_empire_regiment_government
						NOT = { has_character_flag = mustered }
					}
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_infantry > 0
							}
						}
						spawn_army = {
							name = "mamluks"
							men_at_arms = {
								type = ghilman_nubians
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_infantry
							}
							location = scope:liege_capital
							origin = scope:liege_capital
							save_scope_as = ghulam_army
							inheritable = no
							war = scope:war
						}
					}
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_light_cavalry > 0
							}
						}
						spawn_army = {
							name = "mamluks"
							men_at_arms = {
								type = sahel_horsemen
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_light_cavalry
							}
							location = scope:liege_capital
							origin = scope:liege_capital
							save_scope_as = ghulam_army
							inheritable = no
							war = scope:war
						}
					}
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_heavy_cavalry > 0
							}
						}
						spawn_army = {
							name = "mamluks"
							men_at_arms = {
								type = mamluk_cavalry
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_heavy_cavalry
							}
							location = scope:liege_capital
							origin = scope:liege_capital
							save_scope_as = ghulam_army
							inheritable = no
							war = scope:war
						}
					}
				}
			}
		}
		scope:defender = {
			if = {
				limit = {
					has_government = islamic_empire_regiment_government					
				}
				primary_title = {
					save_scope_as = primary_regiment_title
				}
				liege = {
					capital_province = {
						save_scope_as = liege_capital
					}
				}
				## Abid
				if = {
					limit = {
						any_held_title = {
							has_variable = islamic_empire_regiment_size
							has_variable = abid_regiment
						}
						has_government = islamic_empire_regiment_government
						NOT = { has_character_flag = mustered }
					}
					## Troop spawning
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_infantry > 0
							}
						}
						spawn_army = {
							name = "nubian_ghilman"
							men_at_arms = {
								type = ghilman_nubians
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_infantry
							}
							location = scope:liege_capital
							#origin = scope:liege_capital
							save_scope_as = ghulam_army_abid
							inheritable = no
							war = scope:war
						}
					}					
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_light_cavalry > 0
							}
						}
						spawn_army = {
							name = "nubian_ghilman"
							men_at_arms = {
								type = sahel_horsemen
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_light_cavalry
							}
							location = scope:liege_capital
							#origin = scope:liege_capital
							save_scope_as = ghulam_army_abid
							inheritable = no
							war = scope:war
						}
					}
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_heavy_cavalry > 0
							}
						}
						spawn_army = {
							name = "nubian_ghilman"
							men_at_arms = {
								type = mamluk_cavalry
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_heavy_cavalry
							}
							location = scope:liege_capital
							#origin = scope:liege_capital
							save_scope_as = ghulam_army_abid
							inheritable = no
							war = scope:war
						}
					}	
				}
				## turks
				if = {
					limit = {
						any_held_title = {
							has_variable = islamic_empire_regiment_size
							has_variable = turkish_ghulam_regiment
						}
						has_government = islamic_empire_regiment_government
						NOT = { has_character_flag = mustered }
					}
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_infantry > 0
							}
						}
						spawn_army = {
							name = "mamluks"
							men_at_arms = {
								type = ghilman_nubians
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_infantry
							}
							location = scope:liege_capital
							origin = scope:liege_capital
							save_scope_as = ghulam_army
							inheritable = no
							war = scope:war
						}
					}
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_light_cavalry > 0
							}
						}
						spawn_army = {
							name = "mamluks"
							men_at_arms = {
								type = sahel_horsemen
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_light_cavalry
							}
							location = scope:liege_capital
							origin = scope:liege_capital
							save_scope_as = ghulam_army
							inheritable = no
							war = scope:war
						}
					}
					if = {
						limit = {
							primary_title = {
								var:islamic_empire_regiment_size_heavy_cavalry > 0
							}
						}
						spawn_army = {
							name = "mamluks"
							men_at_arms = {
								type = mamluk_cavalry
								stacks = scope:primary_regiment_title.var:islamic_empire_regiment_size_heavy_cavalry
							}
							location = scope:liege_capital
							origin = scope:liege_capital
							save_scope_as = ghulam_army
							inheritable = no
							war = scope:war
						}
					}
				}
			}
		}
		
	}
}

# called for when a casus belli resolves in one of the following ways.
# same scopes are available in these events as in the CBs themselves, this just fires for all CBs instead of a specific CB.
# note that any events/effects fired here WILL NOT show up in the war summary tooltip; they fire at the same time as the war resolution, but are not actually part of the war resolution itself.

on_war_won_attacker = {
	# The war notifications are handled in `effect` instead of `events` due to order of operations.
	# `effect` fires on THIS tick, `events` fires on the NEXT tick, and the war gets destroyed between this tick and the next.
	effect = {
		# Save scopes for localization.
		scope:attacker = { save_scope_as = winner }
		scope:defender = { save_scope_as = loser }

		# Run scripted effect that iterates through all players and notifies them if necessary.
		notify_players_about_neighboring_war_resolution_effect = yes
		
		scope:war = {
			every_war_participant = {
				if = {
					limit = {
						is_ai = yes
						has_character_flag = delayed_cleanse
					}
					trigger_event = { id = game_rule.3 days = 1 }
				}

				## AVE MARIA ROMAN administration clear the mustered flag for the Tagma leaders
				if = {
					limit = {
						#is_at_war = no
						has_character_flag = mustered
					}
					remove_character_flag = mustered
				}			
				
				## Make you roman administration government if you won an indepdendance war
				if = {
					limit = {
						OR = {
							has_government = roman_administration_theme_government
							has_government = roman_administration_doukaton_government
							has_government = roman_administration_military_government
							has_government = roman_administration_kouratoreia_government
						}
						is_independent_ruler = yes
						NOT = {
							this = title:e_byzantium.holder
						}
					}
					change_government = roman_administration_government
					add_realm_law = ave_maria_roman_administration_imperial
				}

				## Removing the variable Imperial Expedition if you had it
				if = {
					limit = {
						# any_held_title = {
						# 	this = title:e_byzantium
						# }
						# has_variable = roman_administration_imperial_expedition
						has_character_flag = roman_administration_imperial_expedition
						
					}
					# remove_variable = roman_administration_imperial_expedition
					remove_character_flag = roman_administration_imperial_expedition
					if = {
						limit = {
							this = scope:attacker
						}
						trigger_event = { 
							id = ave_maria_roman_administration_imperial_expedition_events.0003 
							days = 1 
						}
					}
									
				}	
			}
		}

		

		### AVE MARIA
		## making you roman administrative gov if you go independent
		scope:attacker = {
			if = {
				limit = {
					OR = {
						has_government = roman_administration_government
						has_government = roman_administration_military_government
						has_government = roman_administration_doukaton_government
						has_government = roman_administration_kouratoreia_government
						has_government = roman_administration_sekreton_government
					}
					is_independent_ruler = yes
					NOT = {
						this = title:e_byzantium.holder
					}
				}
				change_government = roman_administration_government
				every_vassal = {
					change_government = roman_administration_government
					every_vassal = {
						change_government = roman_administration_government
					}
				}
				add_realm_law = ave_maria_roman_administration_imperial
			}
		}

		## Counting up victories
		if = {
			limit = {
				scope:attacker = {
					NOT = {
						has_variable = de_re_militari_war_won_counter
					}
				}
				
			}
			scope:attacker = {
				set_variable = {
					name = de_re_militari_war_won_counter
					value = 0
				}
				change_variable = {
					name = de_re_militari_war_won_counter
					add = 1
				}
			}			
		}
		if = {
			limit = {
				scope:attacker = {
					has_variable = de_re_militari_war_won_counter
				}
				
			}
			scope:attacker = {
				change_variable = {
					name = de_re_militari_war_won_counter
					add = 1
				}
			}			
		}

		## Adding legitimacy as Roman emperor
		if = {
			limit = {
				scope:attacker = {
					any_held_title = {
						this = title:e_byzantium
					}
				}				
			}
			scope:attacker = {
				send_interface_message = {
					type = ave_maria_roman_administration_legitimacy_gain_10
					title = {
						first_valid = {
							desc = ave_maria_roman_administration_legitimacy_gain_10.message
						}
					}
					left_icon = scope:attacker
					change_variable = {
						name = roman_administration_legitimacy
						add = 10
					}
				}
				roman_administration_update_legitimacy_level_display = yes
				roman_administration_update_total_salary_cost = yes
			}			
		}
		## Military officials gain also legitimacy
		scope:war = {
			every_war_participant = {
				if = {
					limit = {
						NOT = {
							any_held_title = {
								this = title:e_byzantium
							}
						}
						roman_administration_character_is_in_the_empire = yes
					}
					if = {
						limit = {
							NOT = {
								has_variable = roman_administration_legitimacy
							}
						}
						set_variable = {
							name = roman_administration_legitimacy
							value = 0
						}
					}
					if = {
						limit = {
							has_variable = roman_administration_legitimacy
						}
						send_interface_message = {
							type = ave_maria_roman_administration_legitimacy_gain_10
							title = {
								first_valid = {
									desc = ave_maria_roman_administration_legitimacy_gain_10.message
								}
							}
							left_icon = this
							change_variable = {
								name = roman_administration_legitimacy
								add = 10
							}
						}
					}
									
				}
			}
		}	

		## Removing Legitimacy and Popularity if you are the Emperor and lost
		if = {
			limit = {
				scope:defender = {
					any_held_title = {
						this = title:e_byzantium
					}
				}				
			}
			scope:defender = {
				# change_variable = {
				# 	name = roman_administration_legitimacy
				# 	subtract = 50
				# }
				send_interface_message = {
					type = ave_maria_roman_administration_legitimacy_loss_50
					title = {
						first_valid = {
							desc = ave_maria_roman_administration_legitimacy_loss_50.message
						}
					}
					left_icon = scope:defender
					change_variable = {
						name = roman_administration_popularity
						subtract = 50
					}
				}
				roman_administration_update_legitimacy_level_display = yes
				# change_variable = {
				# 	name = roman_administration_popularity
				# 	subtract = 50
				# }
				send_interface_message = {
					type = ave_maria_roman_administration_popularity_loss_50
					title = {
						first_valid = {
							desc = ave_maria_roman_administration_popularity_loss_50.message
						}
					}
					left_icon = scope:defender
					change_variable = {
						name = roman_administration_popularity
						subtract = 50
					}
				}
				roman_administration_update_popularity_level_display = yes
				roman_administration_update_total_salary_cost = yes
			}
			
		}

		## historical stuff
		if = {
			limit = {
				scope:attacker = {
					this = character:3040
					is_alive = yes
				}
				scope:defender = {
					any_held_title = {
						this = title:e_byzantium
					}
				}
				current_date < 1100
				scope:war = {
					using_cb = invasion_war
					casus_belli = {
						any_target_title = {
							this = title:k_armenia
						}
					}
				}
			}
			title:d_diyarbakr = {
				
				every_in_de_jure_hierarchy = {
					limit = {
						tier = tier_county
						holder = {
							roman_administration_character_is_in_the_empire = yes
						}
					}
					create_title_and_vassal_change = {
						type = conquest
						save_scope_as = change
						add_claim_on_loss = yes
					}
					change_title_holder = {
						holder = character:3040
						change = scope:change
					}
					resolve_title_and_vassal_change = scope:change
				}

				create_title_and_vassal_change = {
					type = conquest
					save_scope_as = change
					add_claim_on_loss = yes
				}
				change_title_holder = {
					holder = character:3040
					change = scope:change
				}
				resolve_title_and_vassal_change = scope:change
			}
		}
	
	}

	events = {

	}
}

on_war_won_defender = {
	effect = {
		# Save scopes for localization.
		scope:attacker = { save_scope_as = loser }
		scope:defender = { save_scope_as = winner }

		# Run scripted effect that iterates through all players and notifies them if necessary.
		notify_players_about_neighboring_war_resolution_effect = yes
		
		scope:war = {
			every_war_participant = {
				if = {
					limit = {
						is_ai = yes
						has_character_flag = delayed_cleanse
					}
					trigger_event = { id = game_rule.3 days = 1 }
				}

				## AVE MARIA ROMAN administration clear the mustered flag for the Tagma leaders
				if = {
					limit = {
						#is_at_war = no
						has_character_flag = mustered
					}
					remove_character_flag = mustered
				}

				if = {
					limit = {
						# any_held_title = {
						# 	this = title:e_byzantium
						# }
						# has_variable = roman_administration_imperial_expedition
						has_character_flag = roman_administration_imperial_expedition
						
					}
					# remove_variable = roman_administration_imperial_expedition
					remove_character_flag = roman_administration_imperial_expedition
					if = {
						limit = {
							this = scope:defender
						}
						trigger_event = { 
							id = ave_maria_roman_administration_imperial_expedition_events.0003 
							days = 1 
						}
					}
					# trigger_event = { 
					# 	id = ave_maria_roman_administration_imperial_expedition_events.0003 
					# 	days = 1 
					# }				
				}
			}
		}


		## AVE MARIA
		## Counting up victories
		if = {
			limit = {
				scope:defender = {
					NOT = {
						has_variable = de_re_militari_war_won_counter
					}
				}				
			}
			scope:defender = {
				set_variable = {
					name = de_re_militari_war_won_counter
					value = 0
				}
				change_variable = {
					name = de_re_militari_war_won_counter
					add = 1
				}
			}			
		}
		if = {
			limit = {
				scope:defender = {
					has_variable = de_re_militari_war_won_counter
				}				
			}
			scope:defender = {
				change_variable = {
					name = de_re_militari_war_won_counter
					add = 1
				}
			}			
		}

		## Adding legitimacy as Roman emperor
		if = {
			limit = {
				scope:defender = {
					any_held_title = {
						this = title:e_byzantium
					}
				}				
			}
			# change_variable = {
			# 	name = roman_administration_legitimacy
			# 	add = 50
			# }
			# change_variable = {
			# 	name = roman_administration_popularity
			# 	add = 50
			# }
			scope:defender = {
				send_interface_message = {
					type = ave_maria_roman_administration_legitimacy_gain_50
					title = {
						first_valid = {
							desc = ave_maria_roman_administration_legitimacy_gain_50.message
						}
					}
					left_icon = scope:defender
					change_variable = {
						name = roman_administration_popularity
						add = 50
					}
				}
				roman_administration_update_legitimacy_level_display = yes
				send_interface_message = {
					type = ave_maria_roman_administration_popularity_gain_50
					title = {
						first_valid = {
							desc = ave_maria_roman_administration_popularity_gain_50.message
						}
					}
					left_icon = scope:defender
					change_variable = {
						name = roman_administration_popularity
						add = 50
					}
				}
				roman_administration_update_popularity_level_display = yes
				roman_administration_update_total_salary_cost = yes
			}
			
		}
		## Military officials gain also legitimacy
		scope:war = {
			every_war_participant = {
				if = {
					limit = {
						roman_administration_character_is_in_the_empire = yes
						NOT = { any_held_title = { this  = title:e_byzantium } }
					}
					if = {
						limit = {
							NOT = {
								has_variable = roman_administration_legitimacy
							}
						}
						set_variable = {
							name = roman_administration_legitimacy
							value = 0
						}
					}
					if = {
						limit = {
							has_variable = roman_administration_legitimacy
						}
						send_interface_message = {
							type = ave_maria_roman_administration_legitimacy_gain_10
							title = {
								first_valid = {
									desc = ave_maria_roman_administration_legitimacy_gain_10.message
								}
							}
							left_icon = this
							change_variable = {
								name = roman_administration_legitimacy
								add = 10
							}
						}
					}
				}
			}
		}

		## Removing Legitimacy and Popularity if you are the Emperor and lost
		if = {
			limit = {
				scope:attacker = {
					any_held_title = {
						this = title:e_byzantium
					}
				}				
			}
			scope:attacker = {
				# change_variable = {
				# 	name = roman_administration_legitimacy
				# 	subtract = 50
				# }
				send_interface_message = {
					type = ave_maria_roman_administration_legitimacy_loss_50
					title = {
						first_valid = {
							desc = ave_maria_roman_administration_legitimacy_loss_50.message
						}
					}
					left_icon = scope:attacker
					change_variable = {
						name = roman_administration_popularity
						subtract = 50
					}
				}
				roman_administration_update_legitimacy_level_display = yes
				# change_variable = {
				# 	name = roman_administration_popularity
				# 	subtract = 50
				# }
				send_interface_message = {
					type = ave_maria_roman_administration_popularity_loss_50
					title = {
						first_valid = {
							desc = ave_maria_roman_administration_popularity_loss_50.message
						}
					}
					left_icon = scope:attacker
					change_variable = {
						name = roman_administration_popularity
						subtract = 50
					}
				}
				roman_administration_update_popularity_level_display = yes
				roman_administration_update_total_salary_cost = yes
			}
			
		}
	}

	events = {

	}
}

on_war_white_peace = {
	effect = {
		scope:war = {
			every_war_participant = {
				if = {
					limit = {
						is_ai = yes
						has_character_flag = delayed_cleanse
					}
					trigger_event = { id = game_rule.3 days = 1 }
				}

				## AVE MARIA ROMAN administration clear the mustered flag for the Tagma leaders
				if = {
					limit = {
						#is_at_war = no
						has_character_flag = mustered
					}
					remove_character_flag = mustered
				}

				if = {
					limit = {
						# any_held_title = {
						# 	this = title:e_byzantium
						# }
						# has_variable = roman_administration_imperial_expedition
						has_character_flag = roman_administration_imperial_expedition
						
					}
					# remove_variable = roman_administration_imperial_expedition
					remove_character_flag = roman_administration_imperial_expedition
					trigger_event = { 
						id = ave_maria_roman_administration_imperial_expedition_events.0003 
						days = 1 
					}				
				}	
			}
		}

	}

	events = {

	}
}

on_war_invalidated = {
	effect = {
		scope:attacker = {
			send_interface_message = {
				type = event_war_invalidated
				title = END_WAR_INVALIDATED_MESSAGE_TITLE
				desc = END_WAR_INVALIDATED_MESSAGE_DESC
				left_icon = scope:attacker
				right_icon = scope:defender
			}
		}
		
		scope:war = {
			every_war_participant = {
				if = {
					limit = {
						is_ai = yes
						has_character_flag = delayed_cleanse
					}
					trigger_event = { id = game_rule.3 days = 1 }
				}

				## AVE MARIA ROMAN administration clear the mustered flag for the Tagma leaders
				if = {
					limit = {
						#is_at_war = no
						has_character_flag = mustered
					}
					remove_character_flag = mustered
				}

				if = {
					limit = {
						# any_held_title = {
						# 	this = title:e_byzantium
						# }
						# has_variable = roman_administration_imperial_expedition
						has_character_flag = roman_administration_imperial_expedition
						
					}
					# remove_variable = roman_administration_imperial_expedition
					remove_character_flag = roman_administration_imperial_expedition
					trigger_event = { 
						id = ave_maria_roman_administration_imperial_expedition_events.0003 
						days = 1 
					}				
				}	
			}
		}

	}

	events = {
		
	}
}
