########################################################################################
#                                         											   #
# AVE MARIA																			   #
# A Very Extensive Modification for Appropriate Realism and Improved Authenticity	   #
#                                         											   #
# NEW COUNCIL TASKS																	   #
#                               													   #
########################################################################################

# Written by Atreides

#############################################
# ROMAN COUNCIL TASKS						#
#############################################

synkellos_task_intellectual_activity = {
	position = councillor_court_chaplain
	# default_task = yes
	
	task_type = task_type_general
	task_progress = task_progress_infinite

	is_shown = {
		scope:councillor_liege = {
			any_held_title = {
				this = title:e_byzantium
			}
		}
	}
	
	effect_desc = synkellos_task_intellectual_activity_desc

	council_owner_modifier = {
		name = court_chaplain_learning_modifier
		monthly_learning_lifestyle_xp_gain_mult = 0.2
		scale = court_chaplain_religious_relations_modifier
	}

	council_owner_modifier = {
		name = court_chaplain_innovation_modifier
		cultural_head_fascination_add = 0.1
		scale = court_chaplain_religious_relations_modifier
	}

	ai_will_do = {
		value = 1 # Always a good backup

	}
}
sakellarios_task_manage_treasury = {
	position = councillor_steward

	is_shown = {
		# scope:councillor_liege = {
		# 	any_held_title = {
		# 		this = title:e_byzantium
		# 	}
		# }
		always = no
	}

	task_type = task_type_general
	task_progress = task_progress_infinite

	effect_desc = {
		desc = sakellarios_task_manage_treasury_desc
	}

	council_owner_modifier = {
		name = task_collect_manage_treasury
		build_gold_cost = -0.2
		scale = steward_collect_taxes_total_scale
	}

	ai_will_do = {
		value = 1 # Always a good backup
	}
}
sakellarios_task_develop_county = {
	position = councillor_steward

	task_type = task_type_county
	county_target = realm
	ai_county_target = domain
	task_progress = task_progress_value
	task_current_value = scope:councillor_liege.steward_develop_county_current_progress
	task_max_value = 100
	highlight_own_realm = yes

	is_shown = {
		# scope:councillor_liege = {
		# 	any_held_title = {
		# 		this = title:e_byzantium
		# 	}
		# }
		always = no
	}

	effect_desc = {
		desc = task_develop_county_complete_effect_desc
		desc = task_develop_county_effect_desc
		desc = {
			desc = council_task_possible_side_effects
			triggered_desc = {
				trigger = {
					stewardship > mediocre_skill_rating
					trigger_if = {
						limit = {
							exists = scope:county
						}
						scope:county = {
							NOT = { has_county_modifier = steward_task_efficient_taxation_modifier }
						}
					}
				}
				desc = task_develop_county_efficient_taxation
			}
			triggered_desc = {
				trigger = {
					stewardship > mediocre_skill_rating
					trigger_if = {
						limit = { exists = scope:county }
						scope:county = {
							county_control < full_county_control
						}
					}
				}
				desc = task_develop_county_increased_control
			}
			triggered_desc = {
				trigger = {
					stewardship < high_skill_rating
					trigger_if = {
						limit = { exists = scope:county }
						scope:county = {
							NOT = { has_county_modifier = steward_settler_resistance_modifier }
						}
					}
				}
				desc = task_develop_county_increased_control
			}
			triggered_desc = {
				trigger = {
					stewardship < high_skill_rating
					trigger_if = {
						limit = { exists = scope:county }
						scope:county = {
							NOT = { has_county_modifier = steward_construction_slowdown_modifier }
						}
					}
				}
				desc = task_develop_county_slow_construction
			}
			triggered_desc = {
				trigger = {
					stewardship < high_skill_rating
					trigger_if = {
						limit = { exists = scope:county }
						scope:county = {
							NOT = { has_county_modifier = steward_population_mismanaged_modifier }
						}
					}
				}
				desc = task_develop_county_loss_of_opinion
			}
			triggered_desc = {
				trigger = {
					stewardship < high_skill_rating
					trigger_if = {
						limit = { exists = scope:county }
						scope:county = {
							county_control > low_county_control
						}
					}
				}
				desc = task_develop_county_loss_of_control
			}
		}
	}

	# TOTAL PROGRESS MUST MATCH THE TOTAL OF THE COUNTY MODIFIERS BELOW
		# Add all new progress values to the script value steward_develop_county_total
		# Note that for Develop County, the County Modifiers apply the actual values, while progress is for player info only
	progress = {
		value = 0
		add = {
			value = steward_develop_county_base
			desc = STEWARD_PROGRESS_BASE
		}
		add = {
			value = scope:councillor.steward_develop_county_monthly_increase
			desc = SCALED_COUNCILLOR_STEWARDSHIP_VALUE
		}
		if = {
			limit = {
				scope:councillor_liege = { has_perk = planned_cultivation_perk }
			}
			add = {
				value = scope:councillor.steward_develop_county_perk_bonus_monthly_increase
				desc = DEVELOP_COUNTY_PERK_BONUS_VALUE
			}
		}
		if = {
			limit = {
				exists = scope:councillor_liege.dynasty
				scope:councillor_liege.dynasty = { has_dynasty_perk = erudition_legacy_5 }
			}
			add = {
				value = scope:councillor.steward_develop_county_erudition_bonus_monthly_increase
				desc = ERUDITION_DYNASTY_PERK_BONUS_VALUE
			}
		}

		# Relation Bonuses/Penalties
		if = { # Friend
			limit = {
				scope:councillor_liege = {
					has_relation_friend = scope:councillor
					NOT = { has_relation_best_friend = scope:councillor }
				}
			}
			add = {
				value = scope:councillor.steward_develop_county_monthly_increase_friend_bonus
				desc = COUNCILLOR_IS_YOUR_FRIEND
			}
		}
		if = { # Best Friend
			limit = {
				scope:councillor_liege = {
					has_relation_best_friend = scope:councillor
				}
			}
			add = {
				value = scope:councillor.steward_develop_county_monthly_increase_best_friend_bonus
				desc = COUNCILLOR_IS_YOUR_BEST_FRIEND
			}
		}
		if = { # Rival
			limit = {
				scope:councillor_liege = {
					has_relation_rival = scope:councillor
					NOT = { has_relation_nemesis = scope:councillor }
				}
			}
			add = {
				value = scope:councillor.steward_develop_county_monthly_increase_rival_bonus
				desc = COUNCILLOR_IS_YOUR_RIVAL
			}
		}
		if = { # Nemesis
			limit = {
				scope:councillor_liege = {
					has_relation_nemesis = scope:councillor
				}
			}
			add = {
				value = scope:councillor.steward_develop_county_monthly_increase_nemesis_bonus
				desc = COUNCILLOR_IS_YOUR_NEMESIS
			}
		}
		if = { #Tribal penalty
			limit = {
				scope:councillor_liege = {
					should_apply_tribal_development_penalty_trigger = yes	
				}
			}
			add = {
				value = scope:councillor.steward_develop_county_tribal_penalty
				desc = DEVELOP_COUNTY_TRIBAL_PENALTY_VALUE
			}
		}	
		if = { # Development reduces the speed.
			limit = {
				exists = scope:county
				scope:county = {
					development_level > 0
				}
			}
			add = {
				value = scope:county.current_development_penalty
				desc = STEWARD_CURRENT_DEVELOPMENT_PENALTY
			}
		}
		
		if = {
			limit = { exists = scope:county }
			multiply = {
				value = scope:county.development_rate_modifier
				desc = STEWARD_COUNTY_SPEED_MODIFIERS
			}
		}
	}
	full_progress = steward_develop_county_full_progress
	custom_other_loc = STEWARD_COUNTY_SPEED_OTHER

	potential_county = {
		scope:county = {
			development_level < max_development_level
			trigger_if = {
				limit = {
					scope:councillor_liege = { is_ai = yes }
				}
				OR = {
					this = scope:councillor_liege.capital_county
					title_province = {
						OR = {
							terrain = oasis
							terrain = farmlands
							terrain = floodplains
						}
					}
				}
			}
		}
	}

	county_modifier = {
		name = steward_develop_county_modifier
		development_growth = 100
		holding_build_speed = -7
		#holding_build_gold_cost = -1
		build_speed = -7
		#build_gold_cost = -1
		scale = { value = steward_develop_county_total divide = 100 }
	}

	county_modifier = {
		name = steward_develop_county_current_development_modifier
		development_growth = 100
		scale = { value = scope:councillor.current_development_penalty divide = 100 }
	}

	county_modifier = {
		name = steward_develop_county_tribal_penalty_modifier
		development_growth = 100
		scale = {
			value = 0
			if = {
				limit = {
					scope:councillor_liege = {
						should_apply_tribal_development_penalty_trigger = yes
					}
				}
				value = scope:councillor.steward_develop_county_tribal_penalty
				divide = 100
			}
		}
	}

	on_finish_task_county = {
		if = {
			limit = {
				OR = {
					AND = {
						exists = scope:county
						scope:county = {
							development_level = max_development_level
						}
					}
					scope:councillor_liege = {
						is_ai = yes
					}
				}
			}
			start_default_task = yes
		}
		scope:councillor_liege = {
			add_character_flag = {
				flag = no_ai_increase_development
				years = 10
			}
		}
	}

	on_start_task = {
		liege = {
			add_character_flag = {
				flag = no_steward_side_effects_first_month
				days = 30
			}
		}
	}

	on_monthly_county = {
		scope:councillor_liege = {
			if = {
				limit = {
					has_character_flag = no_steward_side_effects_first_month
				}
				remove_character_flag = no_steward_side_effects_first_month
				add_character_flag = {
					flag = ai_development_max_years
					years = 10
				}
			}
			else = {
				trigger_event = {
					on_action = task_develop_county_side_effects
					days = { 1 30 }
				}
			}
			
			if = {
				limit = {
					NOT = {
						has_character_flag = ai_development_max_years
					}
				}
				add_character_flag = {
					flag = no_ai_increase_development
					years = 10
				}
			}
		}
	}

	ai_will_do = {
		value = 0
		if = {
			# Don't do this too often
			limit = {
				scope:councillor_liege = { has_character_flag = no_ai_increase_development }
			}
		}
		else_if = {
			limit = {
				scope:councillor_liege.gold >= steward_increase_development_value
			}
			add = 100
		}
	}
}

#############################################
# ISLAMIC EMPIRE COUNCIL TASKS				#
#############################################

## QADI
qadi_render_justice = {
	position = councillor_court_chaplain
	default_task = yes

	task_type = task_type_general
	task_progress = task_progress_infinite

	is_shown = {
		scope:councillor_liege.religion = {
			this = religion:islam_religion
		}
	}
	
	effect_desc = qadi_render_justice_activity_desc

	council_owner_modifier = {
		name = qadi_render_justice_learning_modifier
		county_opinion_add = 0.5
		scale = court_chaplain_religious_relations_opinion_base
	}

	ai_will_do = {
		value = 10 # Always a good backup

	}
}

qadi_develop_county = {
	position = councillor_court_chaplain

	task_type = task_type_county
	county_target = realm
	ai_county_target = domain
	task_progress = task_progress_value
	task_current_value = scope:councillor_liege.steward_develop_county_current_progress
	task_max_value = 100
	highlight_own_realm = yes

	is_shown = {
		scope:councillor_liege.religion = {
			this = religion:islam_religion
		}
	}

	effect_desc = {
		desc = task_develop_county_complete_effect_desc
		desc = task_develop_county_effect_desc
		desc = {
			desc = council_task_possible_side_effects
			triggered_desc = {
				trigger = {
					stewardship > mediocre_skill_rating
					trigger_if = {
						limit = {
							exists = scope:county
						}
						scope:county = {
							NOT = { has_county_modifier = steward_task_efficient_taxation_modifier }
						}
					}
				}
				desc = task_develop_county_efficient_taxation
			}
			triggered_desc = {
				trigger = {
					stewardship > mediocre_skill_rating
					trigger_if = {
						limit = { exists = scope:county }
						scope:county = {
							county_control < full_county_control
						}
					}
				}
				desc = task_develop_county_increased_control
			}
			triggered_desc = {
				trigger = {
					stewardship < high_skill_rating
					trigger_if = {
						limit = { exists = scope:county }
						scope:county = {
							NOT = { has_county_modifier = steward_settler_resistance_modifier }
						}
					}
				}
				desc = task_develop_county_increased_control
			}
			triggered_desc = {
				trigger = {
					stewardship < high_skill_rating
					trigger_if = {
						limit = { exists = scope:county }
						scope:county = {
							NOT = { has_county_modifier = steward_construction_slowdown_modifier }
						}
					}
				}
				desc = task_develop_county_slow_construction
			}
			triggered_desc = {
				trigger = {
					stewardship < high_skill_rating
					trigger_if = {
						limit = { exists = scope:county }
						scope:county = {
							NOT = { has_county_modifier = steward_population_mismanaged_modifier }
						}
					}
				}
				desc = task_develop_county_loss_of_opinion
			}
			triggered_desc = {
				trigger = {
					stewardship < high_skill_rating
					trigger_if = {
						limit = { exists = scope:county }
						scope:county = {
							county_control > low_county_control
						}
					}
				}
				desc = task_develop_county_loss_of_control
			}
		}
	}

	# TOTAL PROGRESS MUST MATCH THE TOTAL OF THE COUNTY MODIFIERS BELOW
		# Add all new progress values to the script value steward_develop_county_total
		# Note that for Develop County, the County Modifiers apply the actual values, while progress is for player info only
	progress = {
		value = 0
		add = {
			value = steward_develop_county_base
			desc = STEWARD_PROGRESS_BASE
		}
		add = {
			value = scope:councillor.steward_develop_county_monthly_increase
			desc = SCALED_COUNCILLOR_STEWARDSHIP_VALUE
		}
		if = {
			limit = {
				scope:councillor_liege = { has_perk = planned_cultivation_perk }
			}
			add = {
				value = scope:councillor.steward_develop_county_perk_bonus_monthly_increase
				desc = DEVELOP_COUNTY_PERK_BONUS_VALUE
			}
		}
		if = {
			limit = {
				exists = scope:councillor_liege.dynasty
				scope:councillor_liege.dynasty = { has_dynasty_perk = erudition_legacy_5 }
			}
			add = {
				value = scope:councillor.steward_develop_county_erudition_bonus_monthly_increase
				desc = ERUDITION_DYNASTY_PERK_BONUS_VALUE
			}
		}

		# Relation Bonuses/Penalties
		if = { # Friend
			limit = {
				scope:councillor_liege = {
					has_relation_friend = scope:councillor
					NOT = { has_relation_best_friend = scope:councillor }
				}
			}
			add = {
				value = scope:councillor.steward_develop_county_monthly_increase_friend_bonus
				desc = COUNCILLOR_IS_YOUR_FRIEND
			}
		}
		if = { # Best Friend
			limit = {
				scope:councillor_liege = {
					has_relation_best_friend = scope:councillor
				}
			}
			add = {
				value = scope:councillor.steward_develop_county_monthly_increase_best_friend_bonus
				desc = COUNCILLOR_IS_YOUR_BEST_FRIEND
			}
		}
		if = { # Rival
			limit = {
				scope:councillor_liege = {
					has_relation_rival = scope:councillor
					NOT = { has_relation_nemesis = scope:councillor }
				}
			}
			add = {
				value = scope:councillor.steward_develop_county_monthly_increase_rival_bonus
				desc = COUNCILLOR_IS_YOUR_RIVAL
			}
		}
		if = { # Nemesis
			limit = {
				scope:councillor_liege = {
					has_relation_nemesis = scope:councillor
				}
			}
			add = {
				value = scope:councillor.steward_develop_county_monthly_increase_nemesis_bonus
				desc = COUNCILLOR_IS_YOUR_NEMESIS
			}
		}
		if = { #Tribal penalty
			limit = {
				scope:councillor_liege = {
					should_apply_tribal_development_penalty_trigger = yes	
				}
			}
			add = {
				value = scope:councillor.steward_develop_county_tribal_penalty
				desc = DEVELOP_COUNTY_TRIBAL_PENALTY_VALUE
			}
		}	
		if = { # Development reduces the speed.
			limit = {
				exists = scope:county
				scope:county = {
					development_level > 0
				}
			}
			add = {
				value = scope:county.current_development_penalty
				desc = STEWARD_CURRENT_DEVELOPMENT_PENALTY
			}
		}
		
		if = {
			limit = { exists = scope:county }
			multiply = {
				value = scope:county.development_rate_modifier
				desc = STEWARD_COUNTY_SPEED_MODIFIERS
			}
		}
	}
	full_progress = steward_develop_county_full_progress
	custom_other_loc = STEWARD_COUNTY_SPEED_OTHER

	potential_county = {
		scope:county = {
			development_level < max_development_level
			trigger_if = {
				limit = {
					scope:councillor_liege = { is_ai = yes }
				}
				OR = {
					this = scope:councillor_liege.capital_county
					title_province = {
						OR = {
							terrain = oasis
							terrain = farmlands
							terrain = floodplains
						}
					}
				}
			}
		}
	}

	county_modifier = {
		name = steward_develop_county_modifier
		development_growth = 100
		holding_build_speed = -7
		#holding_build_gold_cost = -1
		build_speed = -7
		#build_gold_cost = -1
		scale = { value = steward_develop_county_total divide = 100 }
	}

	county_modifier = {
		name = steward_develop_county_current_development_modifier
		development_growth = 100
		scale = { value = scope:councillor.current_development_penalty divide = 100 }
	}

	county_modifier = {
		name = steward_develop_county_tribal_penalty_modifier
		development_growth = 100
		scale = {
			value = 0
			if = {
				limit = {
					scope:councillor_liege = {
						should_apply_tribal_development_penalty_trigger = yes
					}
				}
				value = scope:councillor.steward_develop_county_tribal_penalty
				divide = 100
			}
		}
	}

	on_finish_task_county = {
		if = {
			limit = {
				OR = {
					AND = {
						exists = scope:county
						scope:county = {
							development_level = max_development_level
						}
					}
					scope:councillor_liege = {
						is_ai = yes
					}
				}
			}
			start_default_task = yes
		}
		scope:councillor_liege = {
			add_character_flag = {
				flag = no_ai_increase_development
				years = 10
			}
		}
	}

	on_start_task = {
		liege = {
			add_character_flag = {
				flag = no_steward_side_effects_first_month
				days = 30
			}
		}
	}

	on_monthly_county = {
		scope:councillor_liege = {
			if = {
				limit = {
					has_character_flag = no_steward_side_effects_first_month
				}
				remove_character_flag = no_steward_side_effects_first_month
				add_character_flag = {
					flag = ai_development_max_years
					years = 10
				}
			}
			else = {
				trigger_event = {
					on_action = task_develop_county_side_effects
					days = { 1 30 }
				}
			}
			
			if = {
				limit = {
					NOT = {
						has_character_flag = ai_development_max_years
					}
				}
				add_character_flag = {
					flag = no_ai_increase_development
					years = 10
				}
			}
		}
	}

	ai_will_do = {
		value = 0
		if = {
			# Don't do this too often
			limit = {
				scope:councillor_liege = { has_character_flag = no_ai_increase_development }
			}
		}
		else_if = {
			limit = {
				scope:councillor_liege.gold >= steward_increase_development_value
			}
			add = 100
		}
	}
}

qadi_integrate_title = {
	position = councillor_court_chaplain
	task_type = task_type_county
	county_target = realm
	task_progress = task_progress_value
	task_current_value = scope:councillor_liege.chancellor_integrate_title_current_progress

	task_max_value = define:NTitle|DRIFT_PROGRESS_LIMIT

	is_shown = {
		scope:councillor_liege.religion = {
			this = religion:islam_religion
		}
	}

	effect_desc = {
		desc = task_integrate_title_effect_desc
		desc = {
			desc = council_task_possible_side_effects
			triggered_desc = {
				trigger = {
					diplomacy > mediocre_skill_rating
				}
				desc = task_integrate_title_nobles_support_integration
			}
			triggered_desc = {
				trigger = {
					diplomacy > mediocre_skill_rating
				}
				desc = task_integrate_title_culture_supports_integration
			}
			triggered_desc = {
				trigger = {
					diplomacy < high_skill_rating
				}
				desc = task_integrate_title_nobles_resist_integration
			}
			triggered_desc = {
				trigger = {
					diplomacy < high_skill_rating
				}
				desc = task_integrate_title_culture_resists_integration
			}
		}
	}

	on_start_task = {
		liege = {
			add_character_flag = {
				flag = no_chancellor_side_effects_first_month
				days = 30
			}
		}
	}

	is_valid_showing_failures_only =  {
		liege = {
			custom_description = {
				text = "is_king_or_emperor"
				highest_held_title_tier >= tier_kingdom
				has_religion = religion:islam_religion
			}
		}
	}

	on_finish_task_county = {
		start_default_task = yes
	}

	potential_county = {
		scope:county = {
			de_jure_drifting_towards = scope:councillor_liege.primary_title
		}
	}

	progress = {
		value = 0
		add = {
			value = define:NTitle|DRIFT_MONTHLY_PROGRESS_INCREASE
			desc = PASSIVE_INTEGRATION_PROGRESS_VALUE
		}
		add = {
			value = scope:councillor.chancellor_integrate_title_progress_gain
			desc = SCALED_COUNCILLOR_DIPLOMACY_VALUE
		}
		# Relation Bonuses/Penalties
		if = { # Friend
			limit = {
				scope:councillor_liege = {
					has_relation_friend = scope:councillor
					NOT = { has_relation_best_friend = scope:councillor }
				}
			}
			add = {
				value = scope:councillor.chancellor_integrate_title_monthly_increase_friend_bonus
				desc = COUNCILLOR_IS_YOUR_FRIEND
			}
		}
		if = { # Best Friend
			limit = {
				scope:councillor_liege = {
					has_relation_best_friend = scope:councillor
				}
			}
			add = {
				value = scope:councillor.chancellor_integrate_title_monthly_increase_best_friend_bonus
				desc = COUNCILLOR_IS_YOUR_BEST_FRIEND
			}
		}
		if = { # Rival
			limit = {
				scope:councillor_liege = {
					has_relation_rival = scope:councillor
					NOT = { has_relation_nemesis = scope:councillor }
				}
			}
			add = {
				value = scope:councillor.chancellor_integrate_title_monthly_increase_rival_bonus
				desc = COUNCILLOR_IS_YOUR_RIVAL
			}
		}
		if = { # Nemesis
			limit = {
				scope:councillor_liege = {
					has_relation_nemesis = scope:councillor
				}
			}
			add = {
				value = scope:councillor.chancellor_integrate_title_monthly_increase_nemesis_bonus
				desc = COUNCILLOR_IS_YOUR_NEMESIS
			}
		}
		if = {
			limit = {
				exists = scope:councillor.liege.dynasty
				scope:councillor.liege.dynasty = { has_dynasty_perk = erudition_legacy_5 }
			}
			add = {
				value = scope:councillor.chancellor_integrate_title_erudition_bonus
				desc = INTEGRATE_TITLE_DYNASTY_PERK_BONUS_VALUE
			}
		}
	}

	on_monthly_county = {
		if = {
			# Due to code setup, it might not have invalidated yet if this is not the case
			limit = {
				scope:county = {
					de_jure_drifting_towards = scope:councillor_liege.primary_title
				}
			}
			scope:county = {
				change_de_jure_drift_progress = {
					target = scope:councillor_liege.primary_title
					value = scope:councillor.chancellor_integrate_title_progress_gain
				}
			}
		}

		scope:councillor_liege = {
			if = {
				limit = {
					has_character_flag = no_chancellor_side_effects_first_month
				}
			}
			else = {
				#Side effects
				trigger_event = {
					on_action = task_integrate_title_side_effects
					days = { 1 30 }
				}
			}
		}
	}

	ai_will_do = {
		value = 10 # Prefer this if available
	}
}

## Chancery
insha_fabricate_claim = {
	position = councillor_chancellor

	task_type = task_type_county
	county_target = all
	ai_county_target = neighbor_land
	task_progress = task_progress_percentage
	restart_on_finish = yes

	is_shown = {
		scope:councillor_liege.religion = {
			this = religion:islam_religion
		}
	}	

	effect_desc = {
		desc = task_fabricate_claim_effect_desc

		desc = {
			desc = council_task_possible_side_effects
			triggered_desc = {
				trigger = {
					learning > mediocre_skill_rating
				}
				desc = task_fabricate_claim_duchy_claim
			}
			triggered_desc = {
				trigger = {
					learning < high_skill_rating
				}
				desc = task_fabricate_claim_vassal_opinion_loss
			}
			triggered_desc = {
				trigger = {
					learning < high_skill_rating
				}
				desc = task_fabricate_claim_piety_loss
			}
			triggered_desc = {
				trigger = {
					learning < high_skill_rating
				}
				desc = task_fabricate_claim_upset_target
			}
		}
	}

	progress = {
		value = 0
		add = {
			value = court_chaplain_fabricate_claim_base
			desc = COURT_CHAPLAIN_PROGRESS_BASE
		}
		add = {
			value = scope:councillor.court_chaplain_fabricate_claim_monthly_increase_base
			desc = SCALED_COUNCILLOR_DIPLOMACY_VALUE
		}
		# Relation Bonuses/Penalties
		if = { # Friend
			limit = {
				scope:councillor_liege = {
					has_relation_friend = scope:councillor
					NOT = { has_relation_best_friend = scope:councillor }
				}
			}
			add = {
				value = scope:councillor.court_chaplain_fabricate_claim_monthly_increase_friend_bonus
				desc = COUNCILLOR_IS_YOUR_FRIEND
			}
		}
		if = { # Best Friend
			limit = {
				scope:councillor_liege = {
					has_relation_best_friend = scope:councillor
				}
			}
			add = {
				value = scope:councillor.court_chaplain_fabricate_claim_monthly_increase_best_friend_bonus
				desc = COUNCILLOR_IS_YOUR_BEST_FRIEND
			}
		}
		if = { # Rival
			limit = {
				scope:councillor_liege = {
					has_relation_rival = scope:councillor
					NOT = { has_relation_nemesis = scope:councillor }
				}
			}
			add = {
				value = scope:councillor.court_chaplain_fabricate_claim_monthly_increase_rival_bonus
				desc = COUNCILLOR_IS_YOUR_RIVAL
			}
		}
		if = { # Nemesis
			limit = {
				scope:councillor_liege = {
					has_relation_nemesis = scope:councillor
				}
			}
			add = {
				value = scope:councillor.court_chaplain_fabricate_claim_monthly_increase_nemesis_bonus
				desc = COUNCILLOR_IS_YOUR_NEMESIS
			}
		}
		# Perk Bonuses
		if = {
			limit = {
				scope:councillor_liege = { has_perk = accomplished_forger_perk }
			}
			add = {
				value = scope:councillor.court_chaplain_fabricate_claim_perk_bonus_monthly_increase
				desc = FABRICATE_CLAIM_PERK_BONUS_VALUE
			}
		}
		if = {
			limit = {
				exists = scope:councillor_liege.dynasty
				scope:councillor_liege.dynasty = { has_dynasty_perk = erudition_legacy_5 }
			}
			add = {
				value = scope:councillor.court_chaplain_fabricate_claim_dynasty_perk_bonus
				desc = FABRICATE_CLAIM_DYNASTY_PERK_BONUS_VALUE
			}
		}

		# Innovation Bonuses
		if = {
			limit = {
				scope:councillor.liege = {
					culture = {
						has_innovation = innovation_land_grants
					}
				}
			}
			add = {
				value = scope:councillor.court_chaplain_fabricate_claim_innovation_bonus_land_grants
				desc = COURT_CHAPLAIN_FABRICATE_CLAIM_INNOVATION_BONUS_LAND_GRANTS
			}
		}
		if = {
			limit = {
				exists = scope:county
				NOT = {
					scope:county.holder.faith = scope:councillor.liege.faith
				}
			}
			multiply = {
				value = scope:councillor.court_chaplain_heretic_bonus
				desc = "COURT_CHAPLAIN_FABRICATE_CLAIM_HERETIC_BONUS"
			}
		}
		if = {
			limit = {
				exists = scope:county
				NOT = {
					scope:county = {
						is_neighbor_to_realm = scope:councillor_liege
					}
				}
			}
			multiply = {
				value = scope:councillor.court_chaplain_fabricate_claim_not_adjacent_penalty
				desc = "COURT_CHAPLAIN_FABRICATE_CLAIM_NOT_ADJACENT"
			}
		}
		if = { #Progress penalty when fabricating on vassals
			limit = {
					exists = scope:county
					scope:county.holder = {
						target_is_liege_or_above = scope:councillor.liege 
				}
			}
			multiply = {
				value = scope:councillor.court_chaplain_fabricate_claim_vassal_penalty
				desc = "COURT_CHAPLAIN_FABRICATE_CLAIM_VASSAL_COUNTY"
			}
		}
	}

	potential_county = {
		scope:county.holder.top_liege = {
			in_diplomatic_range = scope:councillor_liege
		}
		scope:county = {
			NOR = {
				holder = scope:councillor_liege
				scope:councillor_liege = {
					has_claim_on = scope:county
				}
			}
		}
	}

	on_finish_task_county = {
		scope:county = {
			holder = {
				save_scope_as = county_holder
			}
		}
		scope:councillor_liege = {
			trigger_event = {
				on_action = task_fabricate_claim_success_effect
			}
		}
	}

	on_start_task = {
		liege = {
			add_character_flag = {
				flag = no_court_chaplain_side_effects_first_month
				days = 30
			}
		}
	}

	on_monthly_county = {
		scope:councillor_liege = {
			if = {
				limit = {
					has_character_flag = no_court_chaplain_side_effects_first_month
				}
			}
			else = {
				trigger_event = {
					on_action = task_fabricate_claim_side_effects
					days = { 1 30 }
				}
			}
		}
	}

	ai_target_score = {
		value = 1000
		
		if = {
			limit = { # Vassals in the same realm
				scope:councillor_liege = {
					is_independent_ruler = no
				}
				scope:county.holder = {
					is_independent_ruler = no
				}
				scope:county.holder.top_liege = scope:councillor_liege.top_liege
			}
			
			if = {
				limit = {
					exists = scope:county.holder.liege
					scope:councillor_liege = {
						any_liege_or_above = {
							this = scope:county.holder.liege
						}
					}
					scope:county.holder.max_military_strength > {
						value = scope:councillor_liege.max_military_strength
						multiply = 1.2
					}
				}
				subtract = 10000
			}
			else_if = {
				limit = {
					exists = scope:county.holder.liege
					scope:councillor_liege = {
						any_liege_or_above = {
							this = scope:county.holder.liege
						}
					}
				}
				multiply = {
					value = scope:councillor_liege.max_military_strength
					divide = { value = scope:county.holder.max_military_strength min = 1 }
				}
			}
			
			else_if = {
				limit = {
					exists = scope:county.holder.liege.liege
					scope:councillor_liege = {
						any_liege_or_above = {
							this = scope:county.holder.liege.liege
						}
					}
					scope:county.holder.liege.max_military_strength > {
						value = scope:councillor_liege.max_military_strength
						multiply = 1.2
					}
				}
				subtract = 10000
			}
			else_if = {
				limit = {
					exists = scope:county.holder.liege.liege
					scope:councillor_liege = {
						any_liege_or_above = {
							this = scope:county.holder.liege.liege
						}
					}
				}
				multiply = {
					value = scope:councillor_liege.max_military_strength
					divide = { value = scope:county.holder.liege.max_military_strength min = 1 }
				}
			}
			
			else_if = {
				limit = {
					exists = scope:county.holder.liege.liege.liege
					scope:councillor_liege = {
						any_liege_or_above = {
							this = scope:county.holder.liege.liege.liege
						}
					}
					scope:county.holder.liege.liege.max_military_strength > {
						value = scope:councillor_liege.max_military_strength
						multiply = 1.2
					}
				}
				subtract = 10000
			}
			else_if = {
				limit = {
					exists = scope:county.holder.liege.liege.liege
					scope:councillor_liege = {
						any_liege_or_above = {
							this = scope:county.holder.liege.liege.liege
						}
					}
				}
				multiply = {
					value = scope:councillor_liege.max_military_strength
					divide = { value = scope:county.holder.liege.liege.max_military_strength min = 1 }
				}
			}
			
			else_if = {
				limit = {
					exists = scope:county.holder.liege.liege.liege.liege
					scope:councillor_liege = {
						any_liege_or_above = {
							this = scope:county.holder.liege.liege.liege.liege
						}
					}
					scope:county.holder.liege.liege.liege.max_military_strength > {
						value = scope:councillor_liege.max_military_strength
						multiply = 1.2
					}
				}
				subtract = 10000
			}
			else_if = {
				limit = {
					exists = scope:county.holder.liege.liege.liege.liege
					scope:councillor_liege = {
						any_liege_or_above = {
							this = scope:county.holder.liege.liege.liege.liege
						}
					}
				}
				multiply = {
					value = scope:councillor_liege.max_military_strength
					divide = { value = scope:county.holder.liege.liege.liege.max_military_strength min = 1 }
				}
			}
		}
		else_if = {
			limit = {
				scope:county.holder.top_liege.max_military_strength > {
					value = scope:councillor_liege.max_military_strength
					multiply = 1.2
				}
			}
			subtract = 10000
		}
		else = {	
			multiply = {
				value = scope:councillor_liege.max_military_strength
				divide = { value = scope:county.holder.top_liege.max_military_strength min = 1 }
			}
		}
	}

	ai_will_do = {
		value = 0
		if = {
			limit = {
				scope:councillor = {
					is_performing_council_task = task_fabricate_claim
				}
			}
			add = 10000 # Always keep going if this is already chosen
		}
		else_if = {
			limit = {
				OR = {
					ai_greed <= ai_honor
					ai_greed <= 0
					is_at_war = yes
					gold < 100
				}
			}
			subtract = 1000
		}
		else_if = { # If AI has good war, don't fabricate
			limit = {
				any_neighboring_and_across_water_top_liege_realm_owner = {
					scope:councillor_liege = {
						tier_difference = {
							target = prev
							value >= -1
						}
						NOR = {
							is_allied_to = prev
							has_truce = prev
						}
						has_any_cb_on = prev
					}			
				}
			}
			subtract = 1000
		}
		else = {
			add = 100
		}
	}
} 

## Karaj
kharaj_streamline_bureaucracy = {
	position = councillor_steward

	task_type = task_type_general
	task_progress = task_progress_infinite

	is_shown = {
		scope:councillor_liege.religion = {
			this = religion:islam_religion
		}
	}

	ai_will_do = {
		value = 1 # Always a good backup
	}
}


## WAZIR
task_grand_vizier_default = {
	default_task = yes
	position = islamic_empire_councillor_grand_vizier

	effect_desc = task_grand_vizier_default_effect_desc

	task_type = task_type_general
	task_progress = task_progress_infinite

	council_owner_modifier = {
		name = task_grand_vizier_default_diplomacy_modifier
		diplomacy = 1
		scale = spouse_default_task_diplomacy_scale
	}

	council_owner_modifier = {
		name = task_grand_vizier_default_martial_modifier
		martial = 1
		scale = spouse_default_task_martial_scale
	}

	council_owner_modifier = {
		name = task_grand_vizier_default_stewardship_modifier
		stewardship = 1
		scale = spouse_default_task_stewardship_scale
	}

	council_owner_modifier = {
		name = task_grand_vizier_default_intrigue_modifier
		intrigue = 1
		scale = spouse_default_task_intrigue_scale
	}

	council_owner_modifier = {
		name = task_grand_vizier_default_learning_modifier
		learning = 1
		scale = spouse_default_task_learning_scale
	}

	on_monthly = {
		scope:councillor_liege = {
			trigger_event = {
				on_action = spouse_councillor_default_on_action
				days = { 0 30 }
			}
		}
	}

	ai_will_do = {
		value = 1 # Always a good backup
	}
}

task_grand_vizier_court_politics = {
	position = islamic_empire_councillor_grand_vizier

	skill = diplomacy
	task_type = task_type_general
	task_progress = task_progress_infinite

	effect_desc = task_court_politics_effect_desc

	council_owner_modifier = {
		name = task_court_politics_modifier
		diplomacy = 1
		scale = spouse_task_court_politics_scale
	}

	on_monthly = {
		scope:councillor_liege = {
			trigger_event = {
				on_action = court_politics_setup
				days = { 0 30 }
			}
		}
	}
}

task_grand_vizier_chivalry = {
	position = islamic_empire_councillor_grand_vizier

	skill = martial
	task_type = task_type_general
	task_progress = task_progress_infinite

	effect_desc = task_chivalry_effect_desc

	council_owner_modifier = {
		name = task_chivalry_modifier
		martial = 1
		scale = spouse_task_chivalry_scale
	}

	on_monthly = {
		scope:councillor_liege = {
			trigger_event = {
				on_action = chivalry_setup
				days = { 0 30 }
			}
		}
	}
}

task_grand_vizier_manage_domain = {
	position = islamic_empire_councillor_grand_vizier

	skill = stewardship
	task_type = task_type_general
	task_progress = task_progress_infinite

	effect_desc = task_manage_domain_effect_desc

	council_owner_modifier = {
		name = task_manage_domain_modifier
		stewardship = 1
		scale = spouse_task_manage_domain_scale
	}

	on_monthly = {
		scope:councillor_liege = {
			trigger_event = {
				on_action = manage_domain_setup
				days = { 0 30 }
			}
		}
	}
}

task_grand_vizier_court_intrigue = {
	position = islamic_empire_councillor_grand_vizier

	skill = intrigue
	task_type = task_type_general
	task_progress = task_progress_infinite

	effect_desc = task_court_intrigue_effect_desc

	council_owner_modifier = {
		name = task_court_intrigue_modifier
		intrigue = 1
		scale = spouse_task_court_intrigue_scale
	}

	on_monthly = {
		scope:councillor_liege = {
			trigger_event = {
				on_action = court_intrigue_setup
				days = { 0 30 }
			}
		}
	}
}

task_grand_vizier_patronage = {
	position = islamic_empire_councillor_grand_vizier

	skill = learning
	task_type = task_type_general
	task_progress = task_progress_infinite

	effect_desc = task_patronage_effect_desc

	council_owner_modifier = {
		name = task_patronage_modifier
		learning = 1
		scale = spouse_task_patronage_scale
	}

	on_monthly = {
		scope:councillor_liege = {
			trigger_event = {
				on_action = patronage_setup
				days = { 0 30 }
			}
		}
	}
}


